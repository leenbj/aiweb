
# AI 建站模板库导入与调用 —— 开发文档（Codex 项目）

> 目标：把**用户上传的静态网页 ZIP** 一键转化为**网站模板库**（页面/组件/主题），并通过 **API/SDK** 在 AI 建站流程中**检索 → 组合 → 渲染 → 生成多文件静态站点**，支持在线**预览**与**一键部署**。本文为工程落地文档，便于研发、测试、运维直接执行。

---

## 目录
1. [项目背景与范围](#项目背景与范围)
2. [术语与约定](#术语与约定)
3. [总体架构与数据流](#总体架构与数据流)
4. [目录结构与代码组织](#目录结构与代码组织)
5. [数据模型（Prisma）](#数据模型prisma)
6. [配置与环境变量](#配置与环境变量)
7. [API 设计（详细）](#api-设计详细)
8. [Importer 设计（ZIP → 模板库）](#importer-设计zip--模板库)
9. [Renderer 设计（HBS/SSR + 校验/净化）](#renderer-设计hbsSSR--校验净化)
10. [RAG 检索与排序策略](#rag-检索与排序策略)
11. [多文件构建器（Build Static）](#多文件构建器build-static)
12. [前端改造点](#前端改造点)
13. [TypeScript SDK](#typescript-sdk)
14. [错误处理与返回规范](#错误处理与返回规范)
15. [安全、合规与权限](#安全合规与权限)
16. [性能与伸缩](#性能与伸缩)
17. [测试计划（单测/集成/E2E）](#测试计划单测集成e2e)
18. [监控、日志与告警](#监控日志与告警)
19. [部署与运维 SOP](#部署与运维-sop)
20. [里程碑与验收标准](#里程碑与验收标准)
21. [风险与缓解](#风险与缓解)
22. [附录：示例模板与样例请求](#附录示例模板与样例请求)

---

## 项目背景与范围

**背景**  
- 当前 AI 直出 HTML 代码存在：风格不一致、可维护性差、安全性不可控的问题。  
- 目标是建立**中心化模板库**，由 API 统一检索与渲染，保证一致性、安全性和效率。

**范围**  
- ✅ 上传静态 ZIP，自动解析为模板（页面/组件）与主题（CSS Token）。  
- ✅ 提供检索、详情、渲染、组合、构建静态站点的 API 与 SDK。  
- ✅ 预览生成结果，支持后续一键部署。  
- ❌ 本期不做复杂 JS 组件的 React SSR（放到 M2）。  
- ❌ 不做 CDN/图像裁剪（预留 Hook）。

---

## 术语与约定

- **Page Template（页面模板）**：包含页面骨架与多个槽位（slots），用于组合组件。  
- **Component Template（组件模板）**：可复用的 UI 片段（如 Header/Hero/Pricing/Team）。  
- **Theme/Token（主题/令牌）**：CSS 变量集合，统一品牌色、圆角、间距等。  
- **Compose（装配）**：以“页面模板 + 组件模板 + 数据 + 主题”生成完整 HTML。  
- **Build Static（静态构建）**：将多页面 HTML + 静态资源落地到文件系统，形成可预览/部署的目录结构。

---

## 总体架构与数据流

```
+-------------------+          +------------------------+
|  Frontend (SPA)   |          |      Backend (API)     |
| - 上传ZIP          |  POST    | - Importer Service     |
| - 模板库检索/预览   +--------> |   (ZIP -> Templates)   |
| - AI 编辑器/预览    |          | - Template Service     |
|                    |          |   (search/get/render/  |
|                    |          |    compose)            |
|                    |          | - Renderer (HBS/SSR)   |
|                    |          | - Assets/Build Service |
+-------------------+          +-----------+------------+
                                           |
                                           | FS / DB
                                           v
                                 +---------+-----------+
                                 |   Storage Layer     |
                                 | - PostgreSQL:       |
                                 |   Template/*        |
                                 | - FS: /uploads,     |
                                 |   /sites/<website>  |
                                 +---------------------+
```

**端到端流程（高层）**  
1) 用户上传 ZIP → Importer 解压、分析、模板化 → 存入 DB 与 /uploads。  
2) AI 生成结构草案 → Template API 检索候选 → 渲染/组合 → 产出 HTML。  
3) Build Static 生成多页面与 static 资源 → /preview/website/:id 预览。  
4) 一键部署沿用现有部署服务。

---

## 目录结构与代码组织

```
backend/
  src/
    routes/
      templates.ts            # search/get/render/compose/import-zip/build-static 入口
    services/
      importer/
        zipImporter.ts        # ZIP 解压与解析
        htmlAnalyzer.ts       # DOM 切分与启发式识别
        schemaGenerator.ts    # JSON Schema 生成
        themeExtractor.ts     # CSS Token 抽取
      templateRenderer.ts     # HBS 渲染 + 校验 + 净化 + 缓存
      templateIndex.ts        # RAG/关键词索引（可选）
      buildService.ts         # 多文件构建 + 资源指纹化 + 路径重写
    middleware/
      auth.ts
      rateLimiter.ts
      error.ts
    utils/
      sanitizer.ts            # HTML/CSS/JS 安全过滤
      file.ts                 # 指纹、MIME、路径工具
      logger.ts
  prisma/schema.prisma

frontend/
  src/
    pages/UploadZip.tsx
    pages/TemplateLibrary.tsx
    components/AIEditorWithNewUI.tsx
    services/templateSDK.ts   # SDK
    store/websiteStore.ts
```

---

## 数据模型（Prisma）

```prisma
model Template {
  id          String   @id @default(cuid())
  type        String   // "component" | "page" | "theme"
  name        String
  slug        String   @unique
  engine      String   // "hbs" | "react" | "plain"
  description String?  @db.Text
  code        String   @db.Text
  schemaJson  Json?
  tokensJson  Json?
  tags        String[]
  version     String   @default("1.0.0")
  previewHtml String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TemplateVersion { // 可选，版本冻结
  id          String   @id @default(cuid())
  templateId  String
  version     String
  code        String   @db.Text
  schemaJson  Json?
  createdAt   DateTime @default(now())
  Template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

model WebsiteAsset {
  id         String   @id @default(cuid())
  websiteId  String
  path       String   // 相对路径：index.html 或 static/css/app.css
  mime       String
  size       Int
  hash       String?
  createdAt  DateTime @default(now())
  Website    Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
}
```

---

## 配置与环境变量

```
# 模板库
TEMPLATE_MAX_UPLOAD_MB=50
TEMPLATE_ALLOWED_MIME=application/zip

# 渲染与缓存
TEMPLATE_ENGINE=HBS
TEMPLATE_LRU_SIZE=300

# 预览与构建
SITES_ROOT=/var/www/sites
UPLOADS_ROOT=/var/www/uploads

# 其他沿用现有后端配置（JWT, DB, CORS, SSE 等）
```

---

## API 设计（详细）

> OpenAPI 规范已提供：`openapi.yaml`。以下为补充说明与请求/响应示例。

### 1) POST `/api/templates/import-zip`
上传静态 ZIP，自动模板化。

- **Request**: `multipart/form-data` with `file`
- **Response**
```json
{
  "success": true,
  "importId": "imp_123",
  "pages": ["index","landing-page","pricing","service","team","embed"],
  "components": ["header","hero","pricing-table","service-list","team-grid","footer"],
  "theme": "default",
  "assetsBase": "/uploads/u1/imp_123/"
}
```

### 2) GET `/api/templates/search`
- **Query**: `query, type, tags[], engine, limit, offset`
- **Response**
```json
{
  "items": [
    {
      "id":"tpl_hero",
      "type":"component",
      "name":"Hero",
      "slug":"hero",
      "engine":"hbs",
      "description":"简洁 Hero 区块",
      "tags":["landing","brand"],
      "version":"1.0.0",
      "schemaJson": { "type":"object", "required":["title"] }
    }
  ],
  "total": 1
}
```

### 3) GET `/api/templates/{slug}`
返回模板详情（含 `code`）。

### 4) POST `/api/templates/render`
- **Body**
```json
{
  "slug":"hero",
  "engine":"hbs",
  "data":{
    "title":"安诺儿童定位器",
    "subtitle":"更安全的随身守护",
    "cta":{"text":"立即购买","href":"/buy"}
  },
  "theme":"default"
}
```
- **Response**
```json
{
  "html":"<section class=\"hero\">...</section>",
  "css":":root{--color-primary:#2b7cff} ...",
  "js":"",
  "meta":{"slug":"hero","version":"1.0.0"}
}
```

### 5) POST `/api/templates/compose`
- **Body**
```json
{
  "page": { "slug":"landing-page" },
  "components": [
    { "slot":"hero","slug":"hero","data":{"title":"安诺","cta":{"text":"立即购买","href":"/buy"}} },
    { "slot":"pricing","slug":"pricing-table","data":{"title":"选择套餐","plans":[{"name":"基础","price":"¥99/月"}]} }
  ],
  "theme":"default"
}
```
- **Response**：完整 HTML（可带 `<head>`）、合并 CSS/JS。

### 6) POST `/api/websites/{id}/build-static`
- **Body**
```json
{
  "pages":[
    {"path":"index.html","pageSlug":"landing-page","components":[...],"theme":"default"},
    {"path":"pricing.html","pageSlug":"pricing","components":[...],"theme":"default"}
  ],
  "assets":[{"from":"/uploads/u1/imp_123/static/css/app.css","to":"static/css/app.css"}],
  "sitemap": true,
  "robots": true,
  "fingerprint": true
}
```
- **Response**
```json
{
  "success": true,
  "files": ["index.html","pricing.html","static/css/app.a1b2c3.css"],
  "previewUrl": "/preview/website/ws_123/index.html"
}
```

### 7) GET `/preview/website/{id}/{path}`
- 静态映射到 `/sites/{id}/{path}`，用于 iframe 预览。

---

## Importer 设计（ZIP → 模板库）

**Pipeline**  
1. **解压与扫描**：收集 HTML/CSS/JS/图片/字体，建立依赖图。  
2. **页面识别与切分**：将 `index.html` 等映射为 Page Template；根据启发式切出 Header/Hero/Pricing/Team 等组件（失败则保留于页面模板内）。  
3. **参数化**：用占位符替换写死文案/链接/列表（`{{title}}`, `{{items}}[]`），生成 `*.schema.json`。  
4. **主题抽取**：把共性样式抽为 Token：`--color-primary, --radius-lg, --space-md`；输出 `themes/default.css`。  
5. **安全与净化**：过滤危险标签与属性；脚本统一 nonce。  
6. **入库与索引**：写入 `Template` 表，生成 `TemplateIndex.indexText` 或向量库文档。  
7. **预览快照**：用样例数据渲染 `previewHtml`。

**启发式规则（可扩展）**  
- `header|navbar` → Header  
- `footer` → Footer  
- 顶部大标题+按钮 → Hero  
- 包含价格/plan/cards 列表 → PricingTable  
- `.team|.member|头像` → TeamGrid  
- `.feature|.service` → ServiceList

**伪代码**
```ts
for each html in htmlFiles:
  dom = parse(html)
  pageSlots = detectSlots(dom)
  components = []
  for slot in pageSlots:
    comp = extractComponent(dom, slot)
    schema = inferSchema(comp)
    saveTemplate({type:'component', slug:slot.slug, code:toHbs(comp), schemaJson:schema})
    components.push(slot.slug)
  pageHbs = toPageHbs(dom, components) // 将组件替换为 {{> partial}}
  saveTemplate({type:'page', slug:pageSlug(html), code:pageHbs})
extractThemeTokens(cssFiles)
copyAssetsToUploads()
indexTemplatesForSearch()
```

---

## Renderer 设计（HBS/SSR + 校验/净化）

- **引擎**：M1 采用 Handlebars；M2 增加 React SSR（`renderToString`）。  
- **Schema 校验**：Ajv/Joi 对 `data` 做强校验，缺参/类型错直接 400。  
- **预编译与缓存**：按 `slug@version` 做 LRU 缓存（300）。  
- **HTML 标准化**：补齐 `<!DOCTYPE html>`、`<html lang="zh-CN">`、闭合标签（可复用现有 `standardizeHtmlDocument`）。  
- **CSS 合并**：主题 + 组件私有样式，去重（基于内容 hash），可选择内联或外链。  
- **安全**：统一插入 CSP nonce；过滤内联事件属性；对外链资源做白名单。

---

## RAG 检索与排序策略

- **索引文本**：`name + description + tags + schema 字段名 + 用法片段`。  
- **向量库**：pgvector / Chroma（二选一）；导入/更新时写入。  
- **排序**：语义相似度 × 业务规则（engine 优先、必备字段覆盖、最近热度）。  
- **回退**：若无匹配，退回同类关键词（hero → banner）。

---

## 多文件构建器（Build Static）

- **输入**：多页面定义（path, pageSlug, components[], theme）+ assets 映射。  
- **处理**：
  - 串/并行调用 `compose`，写入 `/sites/{websiteId}/{path}`；
  - 资源指纹：`static/css/app.<hash>.css`，并替换 HTML 引用；
  - `sitemap.xml` 与 `robots.txt`（可选）。
- **预览**：Nginx/Express 静态映射 `/preview/website/:id/*` → `/sites/:id/*`。

---

## 前端改造点

1. **UploadZip.tsx**：上传 → 解析结果展示（页面/组件/主题/预览）。  
2. **TemplateLibrary.tsx**：检索、筛选（type/tags/engine）、预览（取 `previewHtml`）。  
3. **AI 编辑器集成**：根据 LLM 草案（slots）→ SDK.search → SDK.compose → 右侧预览；生成多页面后调用 `build-static`。  
4. **文件树与预览**：展示站点产物列表；iframe 加载 `/preview/website/:id/index.html`。

---

## TypeScript SDK

```ts
export type TemplateType = 'component'|'page'|'theme';
export type TemplateEngine = 'hbs'|'react'|'plain';

export interface TemplateDTO {
  id: string; type: TemplateType; name: string; slug: string;
  engine: TemplateEngine; description?: string; tags: string[];
  version: string; schemaJson?: any; tokensJson?: any;
}

export class TemplateSDK {
  constructor(private baseURL: string, private token?: string) {}
  private headers() { return { 'Authorization':`Bearer ${this.token}`, 'Content-Type':'application/json' }; }

  async search(params: {query?: string; type?: TemplateType; tags?: string[]; engine?: TemplateEngine; limit?: number; offset?: number}) {
    const q = new URLSearchParams();
    Object.entries(params || {}).forEach(([k,v]) => {
      if (Array.isArray(v)) v.forEach(x=>q.append(k, String(x)));
      else if (v!=null) q.set(k, String(v));
    });
    const r = await fetch(`${this.baseURL}/api/templates/search?${q.toString()}`, { headers: this.headers() });
    return r.json() as Promise<{ items: TemplateDTO[]; total: number }>;
  }

  async get(slug: string) {
    const r = await fetch(`${this.baseURL}/api/templates/${slug}`, { headers: this.headers() });
    return r.json() as Promise<TemplateDTO & { code: string }>;
  }

  async render(body: { slug: string; engine?: TemplateEngine; data?: any; theme?: string }) {
    const r = await fetch(`${this.baseURL}/api/templates/render`, { method:'POST', headers:this.headers(), body:JSON.stringify(body) });
    return r.json() as Promise<{ html: string; css?: string; js?: string; meta: any }>;
  }

  async compose(body: { page: { slug: string; data?: any }; components: { slot: string; slug: string; data?: any }[]; theme?: string }) {
    const r = await fetch(`${this.baseURL}/api/templates/compose`, { method:'POST', headers:this.headers(), body:JSON.stringify(body) });
    return r.json() as Promise<{ html: string; css?: string; js?: string; meta?: any }>;
  }
}
```

---

## 错误处理与返回规范

**统一错误结构**
```json
{ "success": false, "error": { "code": "TEMPLATE_SCHEMA_INVALID", "message": "field title is required", "traceId":"..." } }
```
**常见错误码**
- `ZIP_UNSUPPORTED`：文件类型/大小不合法  
- `TEMPLATE_SCHEMA_INVALID`：数据不符合 schema  
- `TEMPLATE_NOT_FOUND`：slug 不存在  
- `RENDER_ENGINE_ERROR`：引擎异常/编译失败  
- `BUILD_WRITE_FAILED`：写文件失败/磁盘不足  
- `RATE_LIMITED`：频控触发  

---

## 安全、合规与权限

- **上传**：MIME/大小白名单；防目录穿越；可选病毒扫描。  
- **渲染**：过滤内联事件属性（`onerror` 等）；脚本加 nonce；CSP 头。  
- **权限**：模板导入默认“私有”；管理员可设为“全局共享”。  
- **审计**：记录“模板 × 网站 × 用户 × 时间”。

---

## 性能与伸缩

- 预编译模板 + LRU 缓存；`compose` 结果短缓存（相同入参哈希 60s）。  
- 并行构建（p-limit）；I/O 合并写；资源去重与压缩（构建期）。  
- 静态文件通过 Nginx 提供，开启 gzip/br 压缩与缓存头。

---

## 测试计划（单测/集成/E2E）

- **单测**：Importer（切分/参数化）、Renderer（schema 校验）、Build（指纹替换）。  
- **集成**：`import-zip → search → render → compose → build-static → preview` 全链路。  
- **E2E（Playwright）**：上传 ZIP、生成多页、响应式快照（375/768/1280）；aXe 无障碍扫描。

---

## 监控、日志与告警

- 指标：导入时长、渲染时长、构建失败率、预览 5xx 比例。  
- 日志：按 traceId 贯通 Import/Render/Build；保留模板与网站 ID。  
- 告警：导入失败率超阈、磁盘空间、构建超时。

---

## 部署与运维 SOP

1. 迁移数据库：`npx prisma migrate deploy`。  
2. 配置 Nginx：  
   - `/preview/website/{id}/*` → `/sites/{id}/*` 静态映射；  
   - 上传限额与超时。  
3. 滚动发布：灰度启用 Import/Render 路由。  
4. 回滚：保留上个版本镜像与数据库备份。

---

## 里程碑与验收标准

- **M1**（3 周）：
  - 完成 import-zip、search/get、render/compose、build-static、preview 基线；
  - 通过集成与 E2E 测试；生成两套示例站点。
- **M2**（2 周）：
  - React SSR、资源指纹化优化、RAG 召回排序；性能对比报表。
- **M3**（2 周）：
  - 模板市场（团队/权限）、版本冻结/灰度、一键升级站点。

**验收**  
- 上传官方示例 ZIP，10 分钟内完成模板化与生成，预览通过；  
- 同模板多次渲染结果一致；出现缺参时清晰报错；  
- 100 并发渲染 P95 < 500 ms（HBS）；构建 5 页站点 < 5 s（不含部署）。

---

## 风险与缓解

- **HTML 结构复杂，组件切分不准** → 支持“整页模板化”回退 + 人工校正工具。
- **脚本安全风险** → 默认禁用内联脚本；白名单 + CSP nonce。
- **磁盘占用过快** → 站点构建清理策略 + 日志轮转 + 文件指纹复用。

---

## 附录：示例模板与样例请求

**组件模板（Hero, hbs）**
```hbs
<section class="hero">
  <div class="container">
    <h1>{{title}}</h1>
    {{#if subtitle}}<p>{{subtitle}}</p>{{/if}}
    {{#if cta}}<a class="btn" href="{{cta.href}}">{{cta.text}}</a>{{/if}}
  </div>
</section>
```

**Hero schema.json**
```json
{
  "type":"object",
  "properties":{
    "title":{"type":"string"},
    "subtitle":{"type":"string"},
    "cta":{"type":"object","properties":{"text":{"type":"string"},"href":{"type":"string"}},"required":["text","href"]}
  },
  "required":["title"]
}
```

**页面模板（landing-page.hbs）**
```hbs
{{> header site=header.site links=header.links }}
{{> hero title=hero.title subtitle=hero.subtitle cta=hero.cta }}
{{> pricing-table title=pricing.title plans=pricing.plans }}
{{> footer year=footer.year company=footer.company }}
```

**Compose 样例请求**
```json
{
  "page": { "slug":"landing-page" },
  "components": [
    {"slot":"hero","slug":"hero","data":{"title":"安诺儿童定位器","subtitle":"守护孩子出行安全","cta":{"text":"立即购买","href":"/buy"}}},
    {"slot":"pricing","slug":"pricing-table","data":{"title":"选择套餐","plans":[{"name":"基础","price":"¥99/月","features":["精准定位","历史轨迹"]}]}}
  ],
  "theme":"default"
}
```
