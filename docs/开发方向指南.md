# 开发方向指南（Open Lovable / AI Website Builder）

> 基于《docs/技术说明文档-OpenLovable_AI_Website_Builder.md》与当前代码仓库整理。本指南用于明确阶段目标、优先级与验收标准，指导团队有序推进研发与上线。

---

## 1. 愿景与范围

- 愿景：提供“自然语言对话 → 实时生成/编辑网页 → 可视化预览直改 → 一键部署”的端到端低门槛建站体验。
- 范围：Web 端单体应用（前端 React + 后端 Express + Postgres），支持 DeepSeek/OpenAI/Anthropic，支持 Nginx + Certbot 自动化部署与基础统计。
- 非目标（近期）：多租户复杂计费、模板商城、可视化拖拽全站（保留后续规划）。

---

## 2. 里程碑与阶段目标（建议顺序）

> 时长按小团队/平行推进估算，可按人力并行拆分。每个阶段均要求通过 DoD（Definition of Done）后的演示与回归。

- M0 环境与底座（0.5 周）
  - 目标：本地开发可一键跑通；对齐环境变量；准备演示账号与样例数据。
  - 关键项：统一 .env 键名、数据库迁移与 seed、健康检查、CORS/代理验证。
- M1 流式对话与编辑稳定性（1 周）
  - 目标：SSE（AI 对话/生成/编辑）稳定、可中断与继续；前端流式拆分“文本/代码”准确。
  - 关键项：服务端心跳、禁用压缩、前端超时/重试/Abort、围栏与 HTML 块解析。
- M2 网站生成与编辑闭环（1 周）
  - 目标：从“新建 → 生成首版 → 流式微调 → 保存/导出”全流程稳定可用。
  - 关键项：生成/编辑接口校验、内容完整性检查、版本化备份、导出打包。
- M3 一键部署（1–1.5 周）
  - 目标：域名校验 → Nginx 配置 → 重载 → DNS 检查 → SSL 申请/切换 → 状态落库；可观测日志。
  - 关键项：Punycode 转换、权限/路径校验、错误回滚、占位图生成（可异步）。
- M4 Token 记账与统计（0.5–1 周）
  - 目标：按“天+小时+供应商+模型+操作”维度聚合与展示趋势/概览/区间。
  - 关键项：统一记录入口、幂等与重试、费用映射、图表联动与导出。
- M5 权限与设置完善（0.5–1 周）
  - 目标：角色/权限覆盖、用户设置（供应商/模型/三类提示词）与系统默认提示词管理。
  - 关键项：后端权限中间件、前端可视化编辑与回填、连通性测试。
- M6 可观测性与稳定性（滚动）

---

## 2.1 模板库与构建（新增能力，参考《设计文档.md》）

- T1 模板库 Import 基线（0.5–1 周）
  - 路由：`POST /api/templates/import-zip`（multer 接收 ZIP，返回解析清单）。
  - 服务：`importer/*` 解压、页面/组件识别、参数化（schema）、主题 token 抽取、净化与索引。
  - 模型（Prisma）：`Template`、`TemplateVersion`（可选）、`WebsiteAsset`。
  - 预览：入库时生成 `previewHtml`。
- T2 检索/渲染/组合（0.5–1 周）
  - 路由：`GET /api/templates/search|{slug}`、`POST /api/templates/render|compose`。
  - 服务：`templateRenderer`（HBS + Ajv 校验 + LRU 预编译与缓存）、`templateIndex`（索引/排序）。
  - 安全：净化、CSP nonce、内联事件过滤。
- T3 多文件构建与预览（0.5 周）
  - 路由：`POST /api/websites/{id}/build-static`，`GET /preview/website/{id}/{path}` 静态映射。
  - 服务：`buildService` 产出多页面与资源指纹化、`sitemap.xml`/`robots.txt` 可选，预览路径映射到 `/sites/{id}`。
- T4 前端改造与 SDK（0.5–1 周）
  - 页面：`UploadZip.tsx`、`TemplateLibrary.tsx`；编辑器右侧接入 `compose` 预览；最终调用 `build-static`。
  - SDK：`frontend/src/services/templateSDK.ts` 封装 `search/get/render/compose`。
  - 目标：日志/告警/限流/错误语义化；基础压测与容量预估；CSP/安全加固。
  - 关键项：系统日志读取、Nginx/systemd 日志面板、SSE 断链告警、CSP 收敛。

---

## 3. 优先级工作流（P0→P2）

- P0 稳定性与可用性
  - SSE 流程稳定（backend/src/services/aiChat.ts、backend/src/index.ts）
  - 生成/编辑接口与内容完整性（backend/src/services/ai.ts）
  - 本地端到端可运行（README 流程、frontend/vite 代理、CORS）
- P1 端到端体验
  - 直改与同步（frontend/src/components/AIEditorWithNewUI.tsx）
  - 模板库与构建：import/search/render/compose/build-static（新增）
  - 一键部署（backend/src/services/deployment.ts）
  - Token 记账/统计（backend/src/services/tokenTracker.ts + 前端图表页）
- P2 可维护性与增长
  - 提示词体系/默认值（backend/src/constants/prompts.ts + 设置页）
  - 权限覆盖与审计（middleware/roleAuth.ts + user_permissions）
  - 监控与日志面板（/api/server/logs、WS 推送可选）

---

## 4. 详细任务分解与 DoD

### 4.1 基础与环境（M0）
- 任务
  - 对齐环境变量：以 `backend/src/config/index.ts` 为准，梳理 `.env.example` 与 `backend/.env.example` 差异并统一键名与注释。
  - 数据库：执行迁移，补充 `seed`（演示用户、样例网站与对话）。
  - 前端代理/CORS：验证 `Vite` 代理 `/api` → `:3001`，CORS 允许 `:3000/:3002`。
  - 健康检查：`GET /health` 在前端“设置/关于”页可见。
- DoD
  - `npm run dev` 前后端均可启动；首屏可登录/注册；有一条样例对话与网站可演示。

### 4.2 SSE 与对话编辑（M1）
- 任务
  - 服务端：禁用 SSE 压缩、周期心跳、错误语义化（密钥缺失/频控/余额）。
  - 前端：`fetch + ReadableStream` 解析 `data:`，围栏/HTML 块拆分；Abort/超时/重连提示；“继续输出”。
  - 解析准确率：避免将说明文字混入网页；代码块自动写入编辑器并刷新预览。
- DoD
  - 长文本/大页面生成不中断；中途取消能恢复会话继续生成；SSE 断线 30s 内有提示。

### 4.3 生成/编辑闭环（M2）
- 任务
  - `POST /api/ai/generate`、`/edit`、`/optimize` 参数校验（Joi）；服务端净化/补全 HTML。
  - 版本化：写入 `WebsiteBackup`；支持“一键回滚”；导出 zip。
  - 前端：生成完成自动保存；编辑器“保存/回滚/导出”入口明确。
- DoD
  - 从空站点到可用首页的生成只需一次流程；回滚后内容一致；导出包可本地打开。

### 4.4 部署（M3）
- 任务
  - 写入静态产物至 `WEBSITES_PATH/<domain>`；Punycode；权限与覆盖校验。
  - 生成/切换 Nginx（HTTP→HTTPS）；`nginx -t` 校验；`systemctl reload nginx`。
  - DNS 检查；`certbot` 申请与失败重试；状态落库（Website/Deployment/DomainConfig）。
  - 可选：站点缩略图异步生成（截图服务）。
- DoD
  - 正常域名：部署 1 次成功；状态页可见 DNS/SSL；Nginx 生效；访问正常。

### 4.5 Token 统计（M4）
- 任务
  - 统一记录入口（`TokenTracker.recordUsage`），填充 `provider/model/operation`；幂等 + 重试策略。
  - API：`overview/trend/daily/range`；前端图表联动与导出。
- DoD
  - 可查看近 7/30 天趋势与供应商占比；数据与调用量对齐（抽样核对）。

### 4.6 权限与设置（M5）
- 任务
  - 权限覆盖：`requirePermission`+表驱动；关键路由权限校验补全。
  - 设置页：三类提示词、供应商/模型、连通性测试，系统默认提示词加载显示。
- DoD
  - 普通/管理员权限可见差异明确；提示词覆盖优先级明确并生效；连通性测试准确。

### 4.7 可观测性与稳定性（M6）
- 任务
  - 日志：后端结构化日志；系统日志读取接口；前端日志面板与下载。
  - 安全：CSP 收敛（生产去除 `unsafe-eval`）、限流策略分级、错误语义化与 SLO。
  - 压测：SSE 并发与部署压力；容量与告警阈值。
- DoD
  - 常见故障（密钥失效、证书失败、DNS 未生效）有可视化提示与操作建议；日志足以定位。

---

## 5. 研发协作规范

- 分支与合并：按里程碑建立分支，功能完毕通过小 PR 合并；优先可运行小步快跑。
- 代码风格：保持现有风格；TS 严格模式；避免大范围无关改动。
- 错误语义：后端区分 400/401/402/429/5xx；前端按状态文案化提示。
- 配置约定：以 `backend/src/config/index.ts` 为唯一事实来源；示例文件与 README 同步。

---

## 6. 风险与缓解

- 环境变量不一致：统一示例与加载逻辑；CI 校验缺失键；文档示例同步。
- SSE 断流/代理兼容：确认 Nginx 代理头/缓存/压缩设置；客户端心跳与重连提示。
- 证书与 DNS：提供“检测/重试/手动修复指引”；日志采集与可视化。
- 供应商限流/成本：Token 统计与配额；错误语义化；可配置回退模型。

---

## 7. 指标（KPIs）与验收

- 功能性：生成成功率、编辑成功率、部署成功率、证书签发成功率。
- 性能：首条 SSE 时间、端到端生成时长 P50/P95、部署时长 P50/P95。
- 稳定性：SSE 断线率、部署失败率、接口 5xx 率。
- 业务：7/30 天活跃网站数、生成/编辑次数、Token 成本/用户平均成本。

---

## 8. 启动清单（Checklist）

- [ ] `.env` 与 `backend/.env` 对齐并补充注释
- [ ] `npx prisma migrate dev && generate && seed`
- [ ] `npm run dev` 前后端启动验证
- [ ] SSE 流测试（长文本/中断/继续）
- [ ] 生成→编辑→保存→回滚→导出闭环演示
- [ ] 一键部署（含 DNS/SSL）演示
- [ ] Token 统计页展示近 7/30 天
- [ ] 角色/权限差异与设置页覆盖验证

---

## 9. 后续规划（Backlog）

- WebSocket 推送部署/生成进度到指定用户
- 模板体系与行业预设提示词库
- 多人协作与变更审阅（基于 WebsiteBackup 差异）
- 资源 CDN 与图像处理链路（缩略图、压缩、WebP/AVIF）
- 更细粒度的成本预估与配额策略

---

如需将本指南细化为周/日计划或添加测试用例清单，请提出目标迭代周期与团队规模，我们将补充排期与负责人分配表。

---

## 10. 运行与测试（快速指引）

- 准备数据库（推荐 Docker，本地亦可）：
  - `docker run -d --name ai-builder-db -e POSTGRES_USER=ai_builder -e POSTGRES_PASSWORD=ai_builder_pass -e POSTGRES_DB=ai_website_builder -p 5432:5432 postgres:15`
- 配置环境：
  - `cp .env.example backend/.env` 并确认 `DATABASE_URL` 指向上述容器
  - 可选：设置 `SITES_ROOT=./sites`、`UPLOADS_ROOT=./uploads`
- 安装与迁移：
  - `npm run install:all`
  - `cd backend && npx prisma migrate dev -n init_templates && npx prisma generate`
- 启动开发：
  - `npm run dev`（根目录，同时启动前后端）
- 生成示例 ZIP 并导入：
  - `cd backend && npm run create:sample-zip`
  - `curl -F "file=@backend/project/sample-site.zip" http://localhost:3001/api/templates/import-zip`
- 检索与渲染：
  - `GET http://localhost:3001/api/templates/search?query=index`
  - `POST http://localhost:3001/api/templates/render`，body：`{"slug":"index","engine":"plain"}`
- 构建与预览：
  - `POST http://localhost:3001/api/websites/{websiteId}/build-static`，body 示例见《设计文档》
  - 浏览：`http://localhost:3001/preview/website/{websiteId}/index.html`
