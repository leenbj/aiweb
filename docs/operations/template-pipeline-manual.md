# 模板自动化流水线操作手册

该手册为运营与研发共用的执行指南，覆盖提示词入库、模板生成、导入上线到回滚的全流程。所有步骤默认在专用 Workspace 中进行，重要操作需在群内留痕。

## 角色职责

| 阶段 | 负责人 | 核心目标 |
| ---- | ------ | -------- |
| 提示词收集与审核 | 内容运营 | 依据场景标准化提示词、标签与期望组件 |
| 流水线执行 | 平台 RD / 值班工程师 | 触发自动化生成、监控耗时与失败 |
| 结果抽检与上线 | 前端模板组 | 校验生成 HTML/CSS/Schema，确认可交付 |
| 回归监控 | 运维 | 追踪成功率、告警，确保指标正常 |

## 操作流程

1. **提示词准备**
   - 使用《提示词编写指南》（见 `docs/training/prompt-authoring.md`）整理 JSON 或 Markdown；
   - 通过「Prompt 管理」页面的「批量导入」功能提交，确保成功/跳过统计与预期一致。

2. **流水线监控**
   - 打开「模板洞察」面板，观察成功率、耗时与失败原因；
   - 若失败率 > 10%，优先查看 `pipeline-monitoring` 手册中的排查流程，必要时告警值班。

3. **生成结果复核**
   - 在 Prompt 详情右侧查看最新任务，确认组件关联、快照下载链接；
   - 若需回滚，使用模板版本管理或 `merge-template-patches.ts` CLI 合并依赖后重新发布。

4. **上线与同步**
   - 成功模板在模板库中确认 slug / tags 是否正确；
   - 更新相关设计稿与知识库，确保业务方收到最新模板列表。

## ZIP/Prompt 文件规范

- ZIP 导入需包含：`template.json`、`schema.json`、`preview.html`（由流水线自动生成）；
- Prompt 导入 JSON 字段：`name`、`rawText`、`tags[]`，名称需全局唯一；
- Markdown 导入需以 `##` 开头分节，首行作为 `name`，`Tags:` 行可选；
- 所有文件统一 UTF-8 编码，禁止包含敏感信息或外链脚本。

## 常见错误与排查

| 现象 | 排查维度 | 常见修复 |
| ---- | -------- | -------- |
| Planner 报错 `schema-validation-error` | 提示词结构/索引是否匹配 | 清理提示词冗余字段，刷新模板索引 |
| Composer 失败 `missing-template` | 模板 slug 不存在/被禁用 | 检查模板库版本或回滚至历史版本 |
| 导入后样式冲突 | 依赖未合并或 Tailwind 重复 | 使用 `merge-template-patches.ts --dry-run` 查看冲突并手动调整 |
| 生成耗时 > 5s | 模型响应慢/依赖下载慢 | 检查 AI 提供商状态，必要时切换模型或降级运行 |

## 回滚与备用方案

1. 通过模板版本管理查询 `TemplateSnapshot`，确认可回滚版本；
2. 使用 CLI：`npx ts-node server-scripts/merge-template-patches.ts --input <snapshot-dir> --apply` 合并依赖；
3. 若流水线持续失败，可切换到手动 ZIP 导入并通知业务使用上一个稳定模板；
4. 完成后在告警群内回复处理结果并更新《提示词编写指南》的风险案例章节。

