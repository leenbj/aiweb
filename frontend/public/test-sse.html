<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>SSE流式测试</h1>
    <div id="messages">点击下面按钮开始测试...</div>
    <button onclick="testSSE()">测试Chat Stream</button>
    
    <script>
    async function testSSE() {
        console.log('🌊 开始SSE测试');
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '正在测试...';
        
        try {
            // 获取token
            console.log('🔑 正在获取token...');
            const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'demo@example.com', password: 'demo123' })
            });
            
            if (!loginResponse.ok) {
                throw new Error(`登录失败: ${loginResponse.status}`);
            }
            
            const loginData = await loginResponse.json();
            const token = loginData.data.token;
            console.log('🔑 获取到token:', token.substring(0, 20) + '...');
            messagesDiv.innerHTML = 'Token获取成功，开始SSE请求...';
            
            // 开始SSE请求
            console.log('📡 开始SSE请求...');
            const response = await fetch('/api/ai/chat-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    message: '你好',
                    conversationHistory: [],
                    stage: 'gathering',
                    requirements: {}
                })
            });
            
            console.log('📡 SSE响应状态:', response.status);
            
            if (!response.ok) {
                throw new Error(`SSE请求失败: ${response.status}`);
            }
            
            messagesDiv.innerHTML = 'SSE连接成功，等待数据...';
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            let chunkCount = 0;
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    console.log('🏁 SSE读取完成');
                    messagesDiv.innerHTML += '<br><strong>✅ SSE读取完成</strong>';
                    break;
                }
                
                const chunk = decoder.decode(value);
                console.log('📥 原始数据块:', chunk);
                
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('📦 解析数据:', data);
                            
                            if (data.type === 'chunk') {
                                chunkCount++;
                                fullText += data.content;
                                console.log(`🔤 第${chunkCount}个chunk:`, data.content);
                                console.log('🔤 累积文本:', fullText);
                                
                                // 实时显示
                                messagesDiv.innerHTML = `
                                    <p><strong>实时流式文本:</strong></p>
                                    <div style="border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                                        ${fullText}
                                    </div>
                                    <p><small>已接收 ${chunkCount} 个数据块</small></p>
                                `;
                            } else if (data.type === 'done') {
                                console.log('🏁 收到完成信号');
                                messagesDiv.innerHTML += '<br><strong>✅ 流式传输完成</strong>';
                                break;
                            }
                        } catch (e) {
                            console.warn('⚠️ 解析错误:', line, e);
                        }
                    }
                }
            }
            
            if (fullText) {
                messagesDiv.innerHTML += `<br><strong>✅ 成功接收到 ${fullText.length} 个字符的流式内容!</strong>`;
            } else {
                messagesDiv.innerHTML += '<br><strong>❌ 没有接收到任何流式内容</strong>';
            }
            
        } catch (error) {
            console.error('❌ SSE测试失败:', error);
            messagesDiv.innerHTML = `<p style="color: red;"><strong>错误:</strong> ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>



