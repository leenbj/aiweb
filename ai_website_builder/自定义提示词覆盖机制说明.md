# 自定义提示词覆盖机制详细说明

## ✅ 答案：是的，完全覆盖！

**用户自定义提示词会100%完全覆盖系统提示词，而不是追加或合并。**

---

## 🔍 代码实现原理

### 核心逻辑
```typescript
// 文件: backend/src/services/ai.ts (第101行)
let systemPrompt = customPrompt || `系统默认的长提示词内容...`;
//                 👆 如果有自定义    👆 否则使用系统默认
//                 完全替换           作为fallback
```

### JavaScript 逻辑解释
```javascript
// 使用 || 运算符的特性：
// - 如果 customPrompt 存在且非空 → 使用 customPrompt
// - 如果 customPrompt 为 null/undefined/空字符串 → 使用系统默认

// 示例1: 用户有自定义设置
let customPrompt = "简洁回复";
let systemPrompt = customPrompt || "很长的系统默认提示词...";
console.log(systemPrompt); // 结果: "简洁回复"

// 示例2: 用户没有自定义设置  
let customPrompt = null;
let systemPrompt = customPrompt || "很长的系统默认提示词...";
console.log(systemPrompt); // 结果: "很长的系统默认提示词..."
```

---

## 📊 实际对比示例

### 场景1: 系统默认提示词（200+字）
```
你是一个专业的网站需求分析师和AI助手。你的任务是与用户进行友好对话，了解他们的网站需求。

对话原则：
1. 友好、专业、有帮助
2. 逐步引导用户提供网站需求信息
3. 询问关键信息：网站类型、功能需求、设计风格、目标用户等
4. 当收集到足够信息时，总结需求并询问是否开始生成
5. 不要直接生成代码，只负责需求收集和确认

请根据用户消息进行自然对话。
```

### 场景2: 用户自定义提示词（20字）
```
简洁回复，快速收集网站需求。
```

### 实际发送给AI的内容
- **有自定义设置的用户**: 只发送 `"简洁回复，快速收集网站需求。"`
- **无自定义设置的用户**: 发送完整的200+字系统默认提示词

---

## 🎯 覆盖的完整性

### 完全覆盖的功能
1. **聊天对话行为** - AI的回复风格和内容
2. **网站生成规则** - HTML生成的具体要求
3. **输出格式要求** - JSON格式、内容结构等
4. **语言和风格** - 正式/非正式、详细/简洁等

### 用户需要自己处理的
如果用户想要自定义提示词但保留某些系统规则，需要在自定义提示词中手动包含这些规则。

**例如：**
```
// 用户想要简洁回复，但保留JSON格式要求
用户自定义提示词:
"简洁专业地收集网站需求。必须返回JSON格式：{\"reply\": \"回复内容\", \"html\": \"代码内容\"}"
```

---

## ⚠️ 重要注意事项

### 1. 功能性要求不能忽略
虽然完全覆盖，但某些功能性要求必须保留：

**网站生成功能必须保留**:
```
必须返回JSON格式：{"reply": "...", "html": "..."}
```

**聊天功能相对灵活**:
- 可以完全自定义对话风格
- 但建议保留基本的需求收集目标

### 2. 覆盖后的责任
- **系统不会自动补充缺失的规则**
- **用户需要确保自定义提示词的完整性**
- **如果自定义提示词有问题，AI行为可能异常**

### 3. 调试和排查
当AI行为异常时，优先检查用户是否设置了自定义提示词：

```bash
# 查看用户设置
SELECT system_prompt FROM user_settings WHERE user_id = 'xxx';

# 如果返回了内容，说明用户有自定义设置
# 这时AI完全按照用户的自定义提示词工作
```

---

## 🛠️ 最佳实践建议

### 1. 继承式自定义（推荐）
用户可以复制系统默认提示词，然后进行修改：

```
// 基础模板 + 个性化修改
你是专业的网站需求分析师。友好对话，快速收集需求：类型、功能、设计。信息充足时确认生成。

个性化要求：
- 回复简洁明了
- 提供3个具体的案例参考
- 重点关注用户体验
```

### 2. 功能保护
确保关键功能不被破坏：

```
// 网站生成功能的安全自定义
快速生成网站代码。必须返回JSON: {"reply": "确认信息", "html": "完整代码"}
```

### 3. 测试验证
设置自定义提示词后，立即测试：
- 发送几条测试消息
- 确认AI行为符合预期
- 检查输出格式是否正确

---

## 📋 总结

**覆盖机制**: ✅ 完全覆盖，不是追加
**影响范围**: 🎯 100%替换所有系统行为规则  
**用户责任**: ⚠️ 需要确保自定义内容的完整性
**最佳实践**: 🛠️ 基于系统模板进行个性化修改

用户拥有完全的AI行为控制权，但也需要承担相应的配置责任！
