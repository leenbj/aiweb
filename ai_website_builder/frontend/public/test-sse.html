<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>SSEæµå¼æµ‹è¯•</h1>
    <div id="messages">ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    <button onclick="testSSE()">æµ‹è¯•Chat Stream</button>
    
    <script>
    async function testSSE() {
        console.log('ğŸŒŠ å¼€å§‹SSEæµ‹è¯•');
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•...';
        
        try {
            // è·å–token
            console.log('ğŸ”‘ æ­£åœ¨è·å–token...');
            const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'demo@example.com', password: 'demo123' })
            });
            
            if (!loginResponse.ok) {
                throw new Error(`ç™»å½•å¤±è´¥: ${loginResponse.status}`);
            }
            
            const loginData = await loginResponse.json();
            const token = loginData.data.token;
            console.log('ğŸ”‘ è·å–åˆ°token:', token.substring(0, 20) + '...');
            messagesDiv.innerHTML = 'Tokenè·å–æˆåŠŸï¼Œå¼€å§‹SSEè¯·æ±‚...';
            
            // å¼€å§‹SSEè¯·æ±‚
            console.log('ğŸ“¡ å¼€å§‹SSEè¯·æ±‚...');
            const response = await fetch('/api/ai/chat-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    message: 'ä½ å¥½',
                    conversationHistory: [],
                    stage: 'gathering',
                    requirements: {}
                })
            });
            
            console.log('ğŸ“¡ SSEå“åº”çŠ¶æ€:', response.status);
            
            if (!response.ok) {
                throw new Error(`SSEè¯·æ±‚å¤±è´¥: ${response.status}`);
            }
            
            messagesDiv.innerHTML = 'SSEè¿æ¥æˆåŠŸï¼Œç­‰å¾…æ•°æ®...';
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            let chunkCount = 0;
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    console.log('ğŸ SSEè¯»å–å®Œæˆ');
                    messagesDiv.innerHTML += '<br><strong>âœ… SSEè¯»å–å®Œæˆ</strong>';
                    break;
                }
                
                const chunk = decoder.decode(value);
                console.log('ğŸ“¥ åŸå§‹æ•°æ®å—:', chunk);
                
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('ğŸ“¦ è§£ææ•°æ®:', data);
                            
                            if (data.type === 'chunk') {
                                chunkCount++;
                                fullText += data.content;
                                console.log(`ğŸ”¤ ç¬¬${chunkCount}ä¸ªchunk:`, data.content);
                                console.log('ğŸ”¤ ç´¯ç§¯æ–‡æœ¬:', fullText);
                                
                                // å®æ—¶æ˜¾ç¤º
                                messagesDiv.innerHTML = `
                                    <p><strong>å®æ—¶æµå¼æ–‡æœ¬:</strong></p>
                                    <div style="border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                                        ${fullText}
                                    </div>
                                    <p><small>å·²æ¥æ”¶ ${chunkCount} ä¸ªæ•°æ®å—</small></p>
                                `;
                            } else if (data.type === 'done') {
                                console.log('ğŸ æ”¶åˆ°å®Œæˆä¿¡å·');
                                messagesDiv.innerHTML += '<br><strong>âœ… æµå¼ä¼ è¾“å®Œæˆ</strong>';
                                break;
                            }
                        } catch (e) {
                            console.warn('âš ï¸ è§£æé”™è¯¯:', line, e);
                        }
                    }
                }
            }
            
            if (fullText) {
                messagesDiv.innerHTML += `<br><strong>âœ… æˆåŠŸæ¥æ”¶åˆ° ${fullText.length} ä¸ªå­—ç¬¦çš„æµå¼å†…å®¹!</strong>`;
            } else {
                messagesDiv.innerHTML += '<br><strong>âŒ æ²¡æœ‰æ¥æ”¶åˆ°ä»»ä½•æµå¼å†…å®¹</strong>';
            }
            
        } catch (error) {
            console.error('âŒ SSEæµ‹è¯•å¤±è´¥:', error);
            messagesDiv.innerHTML = `<p style="color: red;"><strong>é”™è¯¯:</strong> ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>



