<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>SSE Test</h1>
    <div id="messages"></div>
    <button onclick="testSSE()">Test Chat Stream</button>
    
    <script>
    async function testSSE() {
        console.log('ğŸŒŠ å¼€å§‹SSEæµ‹è¯•');
        const messagesDiv = document.getElementById('messages');
        
        try {
            // è·å–token
            const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'demo@example.com', password: 'demo123' })
            });
            const loginData = await loginResponse.json();
            const token = loginData.data.token;
            console.log('ğŸ”‘ è·å–åˆ°token:', token.substring(0, 20) + '...');
            
            // å¼€å§‹SSEè¯·æ±‚
            const response = await fetch('/api/ai/chat-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    message: 'ä½ å¥½',
                    conversationHistory: [],
                    stage: 'gathering',
                    requirements: {}
                })
            });
            
            console.log('ğŸ“¡ SSEå“åº”çŠ¶æ€:', response.status);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    console.log('ğŸ SSEè¯»å–å®Œæˆ');
                    break;
                }
                
                const chunk = decoder.decode(value);
                console.log('ğŸ“¥ åŸå§‹æ•°æ®å—:', chunk);
                
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('ğŸ“¦ è§£ææ•°æ®:', data);
                            
                            if (data.type === 'chunk') {
                                fullText += data.content;
                                console.log('ğŸ”¤ ç´¯ç§¯æ–‡æœ¬:', fullText);
                                
                                // å®æ—¶æ˜¾ç¤º
                                messagesDiv.innerHTML = `<p>å®æ—¶æ–‡æœ¬: ${fullText}</p>`;
                            }
                        } catch (e) {
                            console.warn('âš ï¸ è§£æé”™è¯¯:', line, e);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('âŒ SSEæµ‹è¯•å¤±è´¥:', error);
            messagesDiv.innerHTML = `<p style="color: red;">é”™è¯¯: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>



